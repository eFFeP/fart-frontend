<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pannello Amministrativo - Smart TP</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            background-image: url('sfondo01.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
    </style>
</head>
<body>
    <div class="landscape-warning">
        <div>
            <p>Per favore, ruota il dispositivo in orizzontale</p>
            <svg viewBox="0 0 24 24" width="50" height="50">
                <path d="M7 1L17 1A2 2 0 0 1 19 3V21A2 2 0 0 1 17 23H7A2 2 0 0 1 5 21V3A2 2 0 0 1 7 1zM7 4V20H17V4H7zM12 21A1 1 0 1 0 12 19 1 1 0 0 0 12 21z" fill="currentColor"/>
                <path d="M10 10L14 14M14 10L10 14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
        </div>
    </div>

    <div class="menu-icon" onclick="toggleMenu()">â˜°</div>

    <nav class="menu" id="sideMenu">
        <ul>
            <li><a href="home.html">Home</a></li>
            <li><a href="#">Profilo</a></li>
            <li><a href="admin-panel.html">Pannello Amministrativo</a></li>
            <li><a href="#" id="logout">Logout</a></li>
        </ul>
    </nav>

    <div class="container">
        <h1>Pannello Amministrativo</h1>
        
        <div class="tab">
            <button class="tablinks" onclick="openTab(event, 'Users')">Gestione Utenti</button>
            <button class="tablinks" onclick="openTab(event, 'Groups')">Gestione Gruppi</button>
            <button class="tablinks" onclick="openTab(event, 'AddUser')">Aggiungi Utente</button>
        </div>

        <div id="Users" class="tabcontent">
            <h2>Gestione Utenti</h2>
            <table id="usersTable">
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Email</th>
                        <th>Ruolo</th>
                        <th>Azioni</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Gli utenti verranno inseriti qui dinamicamente -->
                </tbody>
            </table>
        </div>

        <div id="Groups" class="tabcontent">
            <h2>Gestione Gruppi</h2>
            <button onclick="showAddGroupForm()">Aggiungi Gruppo</button>
            <table id="groupsTable">
                <thead>
                    <tr>
                        <th>Nome Gruppo</th>
                        <th>Descrizione</th>
                        <th>Azioni</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- I gruppi verranno inseriti qui dinamicamente -->
                </tbody>
            </table>
        </div>

        <div id="AddUser" class="tabcontent">
            <h3>Aggiungi Nuovo Utente</h3>
            <form id="addUserForm">
                <!-- Inserisci qui i campi del form per aggiungere un nuovo utente -->
            </form>
        </div>
    </div>

    <div id="userInfoModal" class="modal">
        <div class="modal-content">
            <h3>Informazioni Utente</h3>
            <div id="userInfoContent"></div>
            <div id="userGroupsCheckboxes"></div>
            <textarea id="userNotes" placeholder="Note (solo per amministratori)"></textarea>
            <button onclick="saveUserInfo()">Salva Modifiche</button>
            <button onclick="closeUserInfoModal()">Chiudi</button>
        </div>
    </div>

    <div id="groupModal" class="modal">
        <div class="modal-content">
            <h3>Gestione Gruppo</h3>
            <input type="text" id="groupName" placeholder="Nome Gruppo" required>
            <textarea id="groupDescription" placeholder="Descrizione"></textarea>
            <div id="groupPermissions">
                <!-- Checkbox per le permissioni verranno generate dinamicamente -->
            </div>
            <button onclick="saveGroup()">Salva Gruppo</button>
            <button onclick="closeGroupModal()">Annulla</button>
        </div>
    </div>

    <script>
    function toggleMenu() {
        const menu = document.getElementById('sideMenu');
        menu.classList.toggle('open');
    }

    function openTab(evt, tabName) {
        var i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("tabcontent");
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
        }
        tablinks = document.getElementsByClassName("tablinks");
        for (i = 0; i < tablinks.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" active", "");
        }
        document.getElementById(tabName).style.display = "block";
        evt.currentTarget.className += " active";
        if (tabName === 'Users') {
            loadUsers();
        } else if (tabName === 'Groups') {
            loadGroups();
        }
    }

    function loadUsers() {
    const token = localStorage.getItem('token');
    fetch('https://autisti.onrender.com/admin/users', {
        headers: {
            'Authorization': `Bearer ${token}`
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Accesso non autorizzato');
        }
        return response.json();
    })
    .then(users => {
        const tableBody = document.querySelector("#usersTable tbody");
        tableBody.innerHTML = '';
        users.forEach((user, index) => {
            const backgroundColor = index % 2 === 0 ? 'rgba(115, 89, 74, 0.1)' : 'rgba(115, 89, 74, 0.2)';
            const rows = `
                <tr style="background-color: ${backgroundColor};">
                    <td style="width: 200px; text-align: center;">${user.username}</td>
                    <td style="width: 200px; text-align: center;">${user.email}</td>
                    <td style="width: 200px; text-align: center;">${user.role}</td>
                    <td rowspan="2" style="width: 200px; text-align: center; background-color: ${backgroundColor};">
                        <button onclick="showUserInfo(${user.id})">Info</button>
                        <button onclick="resetPassword(${user.id})">Resetta Password</button>
                        <button onclick="deleteUser(${user.id})">Elimina</button>
                    </td>
                </tr>
                <tr style="background-color: ${backgroundColor};">
                    <td colspan="3" style="text-align: center;">Altri dettagli dell'utente possono essere inseriti qui</td>
                </tr>
            `;
            tableBody.innerHTML += rows;
        });
    })
    .catch(error => {
        console.error('Errore nel caricamento degli utenti:', error);
        if (error.message === 'Accesso non autorizzato') {
            window.location.href = 'index.html';
        }
    });
    }

    function loadGroups() {
        // Implementa la logica per caricare i gruppi
        console.log('Caricamento gruppi...');
    }

    function showAddGroupForm() {
        // Implementa la logica per mostrare il form di aggiunta gruppo
        console.log('Mostra form aggiungi gruppo');
    }

    function saveUserInfo() {
        // Implementa la logica per salvare le informazioni utente
        console.log('Salvataggio informazioni utente...');
    }

    function closeUserInfoModal() {
        document.getElementById('userInfoModal').style.display = 'none';
    }

    function saveGroup() {
        // Implementa la logica per salvare il gruppo
        console.log('Salvataggio gruppo...');
    }

    function closeGroupModal() {
        document.getElementById('groupModal').style.display = 'none';
    }

    function logout() {
        localStorage.removeItem('token');
        window.location.href = 'index.html';
    }

    let inactivityTimer;

    function resetInactivityTimer() {
        clearTimeout(inactivityTimer);
        inactivityTimer = setTimeout(logout, 10 * 60 * 1000); // 10 minuti
    }

    // Resetta il timer su ogni interazione dell'utente
    ['click', 'touchstart', 'mousemove'].forEach(evt => 
        document.addEventListener(evt, resetInactivityTimer, false)
    );

    document.addEventListener('DOMContentLoaded', function() {
        // Inizializzazione della pagina
        openTab(event, 'Users');
        resetInactivityTimer();

        // Aggiungi l'event listener per il pulsante di logout
        const logoutButton = document.getElementById('logout');
        if (logoutButton) {
            logoutButton.addEventListener('click', logout);
        }
    });
</script>
</body>
</html>
